<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{% csrf_token %}">
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }
        .input-field label {
            font-weight: bold;
            font-size: 1.4rem;
        }
        body {
            display: flex;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(45deg, #bde0fe, #caf0f8, #a2d2ff, #90e0ef);
    background-size: 400%;
    animation: gradientBackground 15s ease infinite;
    position: relative;
    overflow: scroll;
        }
        @keyframes gradientBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }



        .background-svg {
    mix-blend-mode: overlay; /* Helps particles blend with gradient */
    opacity: 10; /* Adjusted for visibility */
}
@keyframes gradientBackground {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}







        /* Header Styling */
        .dashboard-header {
            background: #2c3e50;
    color: white;
    padding: 20px 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  
    position: relative;
    z-index: 1;
    transition: all 0.3s ease;
    width: 130%;
    height: 10%;
    margin-left: -11%;
    margin-top: -3%;
    will-change: transform;
        }
        .dashboard-header:hover {
            transform: scale(1.02);
        }
        .dark-mode .dashboard-header {
            background: #1a252f;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
        }

        /* Animated Text Fill Effect */
        .dashboard-header p {
            letter-spacing: 0.2em;
            display: inline-block;
          
            border-width: 4px 0;
            padding: 0.5em 0;
            position: absolute;
            top: 65%;
            left: 49%;
            width: 20em;
            margin: 0 0 0 -10em;
            transform: translateY(-50%);
        }
        .dashboard-header p span {
            font: 600 1.8rem/1 "Poppins", sans-serif;
            letter-spacing: 1px;
            padding: 0.25em 0;
            display: block;
            margin: 0 auto;
            text-shadow: 0 0 80px rgba(255, 255, 255, 0.5);
            background: linear-gradient(90deg, #FFFFFF, #FFFFFF, #E70112);
            background-size: 200% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            -webkit-animation: aitf 5s linear;
            -webkit-transform: translate3d(0, 0, 0);
            -webkit-backface-visibility: hidden;
        }
        @-webkit-keyframes aitf {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* Responsive Header */
        @media (max-width: 768px) {
            .dashboard-header {
                padding: 15px 20px;
            }
            .dashboard-header p {
                width: 18em;
                margin: 0 0 0 -9em;
            }
            .dashboard-header p span {
                font-size: 1.5rem;
            }
        }
        @media (max-width: 480px) {
            .dashboard-header {
                padding: 10px 15px;
            }
            .dashboard-header p {
                width: 16em;
                margin: 0 0 0 -8em;
            }
            .dashboard-header p span {
                font-size: 1.2rem;
            }
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            background: #2c3e50;
            color: white;
            position: fixed;
            left: -250px;
            transition: left 0.1s ease;
            z-index: 100;
        }
        .sidebar.active {
            left: 0;
        }
        .sidebar img {
            margin-left: 30%;
            margin-top: 3.5%;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
        }
        .sidebar ul li {
            padding: 0px;
            border-bottom: 1px solid #34495e;
        }
        .sidebar ul li a {
            color: white;
            text-decoration: none;
            display: block;
            align-items: center;
            cursor: pointer;
            padding: 15px;
            transition: background 0.3s ease;
        }
        .sidebar ul li a:hover,
        .sidebar ul li a.active {
            background: white;
            color: black;
        }
        .sidebar ul li a i {
            margin-right: 10px;
        }

        /* Enhanced Sidebar Animations */
        .sidebar {
            transition: left 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), box-shadow 0.3s ease;
        }
        .sidebar.active {
           
        }
        .sidebar ul li a {
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, background 0.3s ease;
        }
        .sidebar ul li a:hover {
            transform: translateX(5px);
            background: linear-gradient(90deg, #ffffff);
            color: #2c3e50;
        }
        .sidebar ul li a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.4s ease;
        }
        .sidebar ul li a:hover::before {
            left: 100%;
        }

        .toggle-btn {
            position: absolute;
            left: 15px;
            top: 25px;
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            background: transparent;
            color: white;
        }
        .toggle-btn.active {
            color: white;
        }
        .content {
            flex: 1;
            padding: 20px;
            margin-left: 50px;
            transition: margin-left 0.3s ease;
            z-index: 1;
        }
        .content.shifted {
            margin-left: 250px;
        }
        .content h1 {
            text-align: center;
            gap: 30px;
            color: black;
        }
        .vm-hosts-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 2fr));
            gap: 25px;
            margin: 30px 0;
            padding: 0 20px;
            margin-left: -25%;
        }
        .vm-host-btn {
            text-decoration: none;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
            width: 39%;
            margin-left: 20%;
        }
        .btn-content {
            text-align: center;
            color: #2c3e50;
            transition: transform 0.3s ease;
        }
        .btn-content i {
            display: block;
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }
        .btn-content span {
            font-size: 1.5rem;
            font-weight: 600;
            display: block;
        }
        .vm-btn {
            background: linear-gradient(45deg, #FFFFFF, #DFF6FF);
            background-size: 200% 200%;
            animation: gradientBG 5s ease infinite;
            margin-left: 82%;
        }
        .host-btn {
            background: linear-gradient(45deg, #DFF6FF, #FFFFFF);
            background-size: 200% 200%;
            animation: gradientBG 5s ease infinite;
            margin-right: -60%;
        }
        .vm-host-btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }
        .vm-host-btn:hover .btn-content {
            transform: scale(1.05);
        }
        .vm-host-btn:hover i {
            transform: scale(1.2);
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .dark-mode .vm-host-btn {
            background: linear-gradient(45deg, #FFFFFF, #DFF6FF);
            background-size: 200% 200%;
            animation: gradientBG 5s ease infinite;
        }
        .dark-mode .btn-content {
            color: black;
        }
        @media (max-width: 768px) {
            .vm-hosts-buttons {
                grid-template-columns: 1fr;
                padding: 0 10px;
            }
            .vm-host-btn {
                min-height: 120px;
            }
            .btn-content span {
                font-size: 1.2rem;
            }
        }
        .dark-mode {
            background: #1e1e1e;
            color: white;
        }
        .dark-mode .sidebar {
            background: #111;
            color: white;
        }
        .dark-mode .sidebar ul li a {
            color: white;
        }
        .dark-mode .card {
            background: white;
            color:white;
        }
        .dark-mode .activity-feed {
            color: black;
        }
        #profileDropdown {
            display: none;
            position: absolute;
            right: 0;
            background: white;
            color: black;
            border-radius: 5px;
            margin-top: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }
        #profileDropdown p {
            padding: 10px;
            margin: 0;
            cursor: pointer;
        }
        #profileDropdown p:hover {
            background: #eee;
        }
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
            margin-top: 20px;
            margin-left: -50px;
        }
        .quick-actions button {
            padding: 12px 20px;
            border: none;
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        .quick-actions button:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #1a252f, #2980b9);
        }
        .quick-actions button::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.6s ease;
        }
        .quick-actions button:active::after {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
        .activity-feed {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            margin-top: 20px;
            color: black;
        }
        .activity-feed h3 {
            margin-bottom: 15px;
            font-weight: 600;
            color: black;
        }
        .activity-feed ul {
            list-style: none;
            padding: 0;
            color: black;
        }
        .activity-feed ul li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: background 0.3s ease;
            color: black;
        }
        .activity-feed ul li:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .chart-box {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            width: 400px;
            transition: transform 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        .chart-box:hover {
            transform: translateY(-5px);
        }
        .dark-mode .chart-box {
            background: white;
        }
        .chart-box .view-details-btn {
            display: block;
            margin: 10px auto 0;
            padding: 10px 20px;
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: transform 0.3s ease;
        }
        .chart-box .view-details-btn:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #1a252f, #2980b9);
        }
        .logoutbtn {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 10px;
            height: 10%;
            background: #e74c3c;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid black;
            margin-top: 0.5%;
            z-index: 10;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            display: flex;
        }
        .modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal {
            transform: scale(1);
        }
        .modal h2 {
            margin-bottom: 20px;
            font-weight: 600;
            color: #2c3e50;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .modal-buttons button {
            padding: 12px 25px;
            font-size: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .modal-buttons button:hover {
            transform: scale(1.05);
        }
        .cancel-btn {
            background: linear-gradient(45deg, #ccc, #bbb);
        }
        .logout-confirm-btn {
            background-color: #e74c3c;
            color: white;
        }
        .sidebar .dropdown-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            backdrop-filter: blur(2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
            opacity: 0;
        }
        .sidebar .dropdown-menu.show {
            max-height: 800px;
            padding: 10px 0;
            opacity: 1;
        }
        .sidebar .dropdown-item {
            color: white;
            text-decoration: none;
            display: block;
            padding: 12px 30px;
            background: #2c3e50;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            transform: translateX(-10px);
            opacity: 0;
            font-size: 0.8rem;
        }
        .sidebar .dropdown-menu.show .dropdown-item {
            transform: translateX(0);
            opacity: 1;
            transition-delay: calc(0.1s * var(--item-index));
        }
        .sidebar .dropdown-item:hover {
            background: white;
            color: black;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transform: translateX(5px) scale(1.02);
        }
        .sidebar .dropdown-item::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.6s ease;
        }
        .sidebar .dropdown-item:active::after {
            transform: translate(-50%, -50%) scale(2);
            opacity: 0;
        }
        .sidebar .dropdown-item .tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #2c3e50;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 10;
        }
        .sidebar .dropdown-item:hover .tooltip {
            opacity: 1;
            transform: translate(10px, -50%);
        }
        .sidebar .dropdown-submenu {
            position: relative;
        }
        .sidebar .dropdown-submenu .dropdown-submenu {
            position: absolute;
            left: 100%;
            top: 10;
            color: black;
            width: 200px;
            display: none;
            transform: translateX(-8px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .sidebar .dropdown-submenu:hover .dropdown-menu {
            display: block;
            transform: translateX(0);
            opacity: 1;
        }
        .sidebar .dropdown-toggle-icon {
            float: right;
            margin-top: 2px;
            margin-right: 8%;
            transition: transform 0.3s ease, color 0.3s ease;
        }
        .sidebar .dropdown-toggle-icon:hover {
            color: #3498db;
        }
        .sidebar .dropdown-toggle-icon.rotate {
            transform: rotate(180deg);
        }
        .dark-mode .sidebar .dropdown-menu {
            background: rgba(17, 17, 17, 0.95);
        }
        .dark-mode .sidebar .dropdown-item {
            color: white;
            background: #111;
        }
        .dark-mode .sidebar .dropdown-item:hover {
            background: white;
            color: black;
        }
        .dark-mode .sidebar .dropdown-item .tooltip {
            background: #1a252f;
            font-size: 3rem;
        }
        @media (max-width: 768px) {
            .sidebar .dropdown-menu {
                width: 100%;
            }
            .sidebar .dropdown-submenu .dropdown-menu {
                position: static;
                width: 100%;
                transform: none;
            }
            .sidebar .dropdown-item .tooltip {
                display: none;
            }
            .content {
                margin-left: 0;
            }
            .content.shifted {
                margin-left: 0;
            }
            .vm-hosts-buttons {
                margin-left: 0;
            }
            .vm-btn {
                margin-left: 0;
                width: 100%;
            }
            .host-btn {
                margin-right: 0;
                width: 100%;
            }
            .topright {
                right: 10px;
                top: 10px;
                gap: 10px;
            }
        }
        /* Added for VM Summary */
        .vm-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
            font-family: "Segoe UI", sans-serif;
        }
        .vm-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            width: 300px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .vm-card h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }
        .vm-card ul {
            list-style: none;
            padding: 0;
        }
        .vm-card ul li {
            margin-bottom: 8px;
        }
        .power-box {
            background-color: #f5f5f5;
            border: 1px solid #ccc;
            text-align: center;
            padding: 40px 0;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .vm-card button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            border-radius: 5px;
            background-color: #0074c1;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }
        .vm-card button.disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .dark-mode .vm-card {
            background: #333;
            border-color: #555;
            color: white;
        }
        .dark-mode .vm-card h2 {
            color: #ddd;
        }
        .dark-mode .power-box {
            background-color: #444;
            border-color: #666;
            color: white;
        }

        .progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        #progressBar {
            width: 0%;
            height: 100%;
            background-color: #3498db;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        .modal {
            margin-left: 10%;
        }

        /* vCenter Dropdown Styling */
        .vcenter-switcher {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .vcenter-switcher i {
            font-size: 24px;
            color: white;
            transition: transform 0.3s ease;
        }
        .vcenter-selected {
            padding: 5px 10px;
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.3s ease;
        }
        .vcenter-selected:hover {
            transform: scale(1.05);
            background: linear-gradient(45deg, #1a252f, #2980b9);
        }
        .vcenter-selected::after {
            content: "▼";
            font-size: 0.8em;
            margin-left: 5px;
        }
        .vcenter-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            color: black;
            border-radius: 5px;
            margin-top: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            min-width: 200px;
        }
        .vcenter-dropdown.active {
            display: block;
        }
        .vcenter-option {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .vcenter-option:hover {
            background: #eee;
        }
        .vcenter-option i {
            color: #2c3e50;
            font-size: 0.9rem;
        }
        @media (max-width: 768px) {
            .vcenter-selected {
                font-size: 0.8rem;
                padding: Cafe
            }
    </style>  
</head>
<body>
    <div class="toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>
    <div class="topright" style="position:absolute; right: 100px; top: 15px; display:flex; align-items:center; gap:15px; z-index:10; color:white;">
        <div id="notification" style="position:relative; color:white; cursor:pointer;">
            <i class="fas fa-bell" style="font-size:24px;color:white; transition: transform 0.3s ease;"></i>
            <span style="position:absolute; top:-5px; right:-10px; background:red; color:white; font-size:12px; border-radius:50%; padding:2px 6px;">3</span>
        </div>
        <div id="profile" style="position:relative; cursor:pointer;">
            <i class="fas fa-user-circle" style="font-size:26px; transition: transform 0.3s ease; color:white;"></i>
            <div id="profileDropdown">
                <p>administrator@vsphere.local</p>
                <p onclick="alert('Settings coming soon!')">Settings</p>
                <p onclick="alert('change password coming soon!')">Change Password</p>
            </div>
        </div>
        <div class="vcenter-switcher" id="vcenterSwitcher">
            <i class="fas fa-globe"></i>
            <div class="vcenter-selected" id="vcenterSelected">Select vCenter</div>
            <div class="vcenter-dropdown" id="vcenterDropdown">
                <!-- vCenters will be populated by JavaScript -->
            </div>
        </div>
        <button onclick="toggleDarkMode()" style="padding:5px 10px; background:white; border:none; border-radius:8px; cursor:pointer; color:white; transition: transform 0.3s ease;">🌙</button>
    </div>

    <div class="sidebar" id="sidebar">
        <img src="https://logos-world.net/wp-content/uploads/2022/07/Lenovo-Logo.png" height="60px" alt="Lenovo Logo">
        <div style="padding:10px;">
            <input type="text" placeholder="Search..." style="width:90%; padding:8px; border-radius:5px; border:none; background:white; color:black;">
        </div>
        <ul>
            <li><a href="{% url 'deploy_vm' %}"><i class="fas fa-home"></i> Dashboard</a></li>
            <li>
                <a href="#"><i class="fas fa-desktop"></i> Virtual Machines <i class="fas fa-chevron-down dropdown-toggle-icon"></i></a>
                <ul class="dropdown-menu">
                    <li><a href="{% url 'create-vm' %}" class="dropdown-item"><i class="fas fa-laptop-code"></i>NEW VIRTUAL MACHINE</a></li>
                    <li><a href="{% url 'vm_list' %}" class="dropdown-item"><i class="fas fa-cube"></i> VM DETAILS</a></li>
                    <li><a href="{% url 'vm_new_list' %}" class="dropdown-item"><i class="fas fa-list"></i> VM DISTRIBUTION LIST</a></li>
                    <li><a href="#" class="dropdown-item" onclick="alert('Clone VM: Coming soon!')"><i class="fas fa-ethernet"></i> CLONE VM</a></li>
                    <li class="dropdown-submenu">
                        <a href="#" class="dropdown-item dropdown-toggle"><i class="fas fa-camera"></i>SNAPSHOTS</a>
                        <ul class="dropdown-menu sub-menu">
                            <li><a href="{% url 'vm_list' %}" class="dropdown-item" onclick="alert('Convert to Template: Coming soon!')"><i class="fas fa-camera"></i>Take Snapshot</a></li>
                            <li><a href="#" class="dropdown-item" onclick="alert('Export OVF Template: Coming soon!')"><i class="fas fa-camera"></i>Manage Snapshots</a></li>
                            <li><a href="#" class="dropdown-item" onclick="alert('Export OVF Template: Coming soon!')"><i class="fas fa-camera"></i>Delete Snapshots</a></li>
                        </ul>
                    </li>
                    <li class="dropdown-submenu">
                        <a href="#" class="dropdown-item dropdown-toggle"><i class="fas fa-file-export"></i>TEMPLATES</a>
                        <ul class="dropdown-menu sub-menu">
                            <li><a href="{% url 'vm_list' %}" class="dropdown-item" onclick="alert('Convert to Template: Coming soon!')"><i class="fas fa-file-export"></i> Convert to Template</a></li>
                            <li><a href="#" class="dropdown-item" onclick="alert('Export OVF Template: Coming soon!')"><i class="fas fa-file-export"></i>Export OVF Template</a></li>
                        </ul>
                    </li>
                    <li class="dropdown-submenu">
                        <a href="#" class="dropdown-item dropdown-toggle"><i class="fas fa-power-off"></i> POWER OPERATIONS</a>
                        <ul class="dropdown-menu sub-menu">
                            <li><a href="{% url 'vm_list' %}" class="dropdown-item" onclick="alert('Power On: Select VM to Power On!')"><i class="fas fa-play"></i> Power On</a></li>
                            <li><a href="{% url 'vm_list' %}" class="dropdown-item" onclick="alert('Power Off: Select VM to Power Off')"><i class="fas fa-stop"></i> Power Off</a></li>
                            <li><a href="#" class="dropdown-item" onclick="alert('Restart: Coming soon!')"><i class="fas fa-redo"></i> Restart</a></li>
                        </ul>
                    </li>
                </ul>
            </li>
            <li><a href="{% url 'host_list' %}"><i class="fas fa-cubes"></i> Host Details</a></li>
            <li><a href=""><i class="fas fa-chart-line"></i> Monitor</a></li>
            <li><a href="#"><i class="fas fa-tools"></i> Configure</a></li>
            <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
            <li><a href="https://chatgpt.com/?model=auto"><i class="fas fa-question-circle"></i> Help</a></li>
            <li><a href="https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/vsphere-virtual-machine-administration-guide-8-0/deploying-virtual-machinesvsphere-vm-admin/deploy-a-virtual-machine-from-a-template-h5vsphere-vm-admin.html"><i class="fas fa-info-circle"></i> How to Deploy VM</a></li>
        </ul>
    </div>

    <svg class="background-svg" width="100%" height="100%" style="position: fixed; top: 0; left: 0; z-index: -2; pointer-events: none;">
    <defs>
        <filter id="blur" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="2"/>
        </filter>
    </defs>
    <g filter="url(#blur)">
        <!-- Particle 1 -->
        <circle cx="10%" cy="10%" r="8" fill="#2c3e50" opacity="10"> <!-- Corrected opacity from 10 to 0.4 -->
            <animate attributeName="cx" values="-20%; 120%; -20%" dur="20s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="-20%; 120%; -20%" dur="25s" repeatCount="indefinite"/>
            <animate attributeName="r" values="8; 12; 8" dur="10s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 2 -->
        <circle cx="30%" cy="70%" r="12" fill="#2c3e50" opacity="10">
            <animate attributeName="cx" values="0%; 110%; 0%" dur="18s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="130%; -10%; 130%" dur="22s" repeatCount="indefinite"/>
            <animate attributeName="r" values="12; 15; 12" dur="12s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 3 -->
        <circle cx="70%" cy="40%" r="10" fill="#2c3e50" opacity="10">
            <animate attributeName="cx" values="130%; -10%; 130%" dur="15s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="0%; 110%; 0%" dur="20s" repeatCount="indefinite"/>
            <animate attributeName="r" values="10; 14; 10" dur="14s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 4 -->
        <circle cx="50%" cy="30%" r="9" fill="#2c3e50" opacity="10">
            <animate attributeName="cx" values="-30%; 130%; -30%" dur="22s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="120%; -20%; 120%" dur="18s" repeatCount="indefinite"/>
            <animate attributeName="r" values="9; 13; 9" dur="11s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 5 -->
        <circle cx="90%" cy="60%" r="11" fill="#2c3e50" opacity="10">
            <animate attributeName="cx" values="120%; -20%; 120%" dur="17s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="140%; 0%; 140%" dur="23s" repeatCount="indefinite"/>
            <animate attributeName="r" values="11; 15; 11" dur="13s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 6 -->
        <circle cx="20%" cy="50%" r="7" fill="#2c3e50" opacity="10">
            <animate attributeName="cx" values="-10%; 110%; -10%" dur="19s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="10%; 130%; 10%" dur="21s" repeatCount="indefinite"/>
            <animate attributeName="r" values="7; 11; 7" dur="9s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 7 -->
        <circle cx="40%" cy="80%" r="10" fill="#2c3e50" opacity="10">
            <animate attributeName="cx" values="0%; 120%; 0%" dur="16s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="-30%; 130%; -30%" dur="24s" repeatCount="indefinite"/>
            <animate attributeName="r" values="10; 14; 10" dur="15s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 8 -->
        <circle cx="60%" cy="20%" r="13" fill="#2c3e50" opacity="10">
            <animate attributeName="cx" values="130%; -20%; 130%" dur="21s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="110%; -10%; 110%" dur="19s" repeatCount="indefinite"/>
            <animate attributeName="r" values="13; 16; 13" dur="12s" repeatCount="indefinite"/>
        </circle>
        <!-- Particle 9 -->
        <circle cx="80%" cy="90%" r="8" fill="#2c3e50" opacity="10">
           <animate attributeName="cx" values="-20%; 120%; -20%" dur="20s" repeatCount="indefinite"/>
            <animate attributeName="cy" values="150%; -10%; 150%" dur="17s" repeatCount="indefinite"/>
            <animate attributeName="r" values="8; 12; 8" dur="10s" repeatCount="indefinite"/>
        </circle>
    </g>
</svg>


        <div class="content" id="content">
            <div class="dashboard-header">
                <p>
                    <span>DASHBOARD</span>
                </p>
            </div>
        
        <div class="quick-actions" id="quick">
            <button onclick="alert('Restarting vCenter...')">Restart vCenter</button>
        </div>
        <div class="vm-hosts-buttons">
            <a href="{% url 'vm_list' %}" class="vm-host-btn vm-btn">
                <div class="btn-content">
                    <i class="fas fa-server fa-2x"></i>
                    <span>Virtual Machines</span>
                </div>
            </a>
            <a href="{% url 'host_list' %}" class="vm-host-btn host-btn">
                <div class="btn-content">
                    <i class="fas fa-network-wired fa-2x"></i>
                    <span>Hosts</span>
                </div>
            </a>
        </div>
        <div class="chart-container">
            <div class="chart-box">
                <!-- Hidden div to store VM distribution data -->
                <div id="vm-distribution-data" 
                     hx-get="/api/vm-distribution"
                     hx-trigger="load, every 3s" 
                     hx-swap="outerHTML"
                     style="display: none;"
                     data-linux-vms="60" 
                     data-windows-vms="30" 
                     data-others="10">
                </div>
                <!-- Add a div to display the total VMs -->
                <div id="total-vms" style="text-align: center; font-weight: bold; margin-bottom: 10px;">
                    Total VMs: 100 <!-- Initial value, will be updated dynamically -->
                </div>
                <canvas id="vmChart" style="max-height: 300px;"></canvas>
                <!-- Add button to navigate to vm_new_list page -->
                <a href="{% url 'vm_new_list' %}" class="view-details-btn">VM Distribution Analysis</a>
              
            </div>
            <div class="chart-box">
                <canvas id="uptimeChart"></canvas>
            </div>
        </div>
        <div class="activity-feed">
            <h3>Recent Activity</h3>
            <ul id="activity-list" 
                hx-get="/recent-activity/" 
                hx-trigger="load, every 10s" 
                hx-swap="outerHTML">
                <li>Loading recent activity...</li>
            </ul>
        </div>
    </div>
    <button class="logoutbtn" onclick="showLogoutModal()">Logout</button>

    <!-- Progress Bar Modal -->
    <div class="modal-overlay" id="progressModal">
        <div class="modal">
            <h2>Loading <span id="categoryName"></span> VMs...</h2>
            <div class="progress-bar-container" style="width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 10px; margin: 20px 0; ">
                <div id="progressBar" style="width: 0%; height: 100%; background-color: #3498db; border-radius: 10px; transition: width 0.1s linear;"></div>
            </div>
            <p>Please wait while we fetch the data.</p>
        </div>
    </div>

    <div class="modal-overlay" id="logoutModal">
        <div class="modal">
            <h2>Are you sure you want to logout?</h2>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeLogoutModal()">Cancel</button>
                <button class="logout-confirm-btn" onclick="confirmLogout()">Logout</button>
            </div>
        </div>
    </div>









<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Default vCenters (same as login.html)
    const defaultVcenters = [
        { url: "https://coevcenter.lenovo.com", name: "Lenovo vCenter", source: "default" },
        { url: "https://backupvcenter.lenovo.com", name: "Backup Lenovo vCenter", source: "default" },
        { url: "https://testvc.coelab.com", name: "Test vCenter", source: "default" }
    ];

    // Simulate authentication state (for demo purposes)
    document.addEventListener("DOMContentLoaded", () => {
        let authTokens = JSON.parse(localStorage.getItem("authTokens")) || {};
        // Mock: Assume user is authenticated for the default vCenter only
        if (!authTokens["https://coevcenter.lenovo.com"]) {
            authTokens["https://coevcenter.lenovo.com"] = "mock-token-123";
        }
        localStorage.setItem("authTokens", JSON.stringify(authTokens));
    });

    function loadVcenters() {
        const storedVcenters = JSON.parse(localStorage.getItem("vcenters")) || [];
        const customVcenters = storedVcenters.map(vcenter => ({ ...vcenter, source: "custom" }));
        const deletedVcenters = JSON.parse(localStorage.getItem("deletedVcenters")) || [];
        const deletedUrls = new Set(deletedVcenters);
        
        // Combine all vCenters
        const allVcenters = [...defaultVcenters, ...customVcenters];
        
        // Remove duplicates and filter out deleted vCenters
        const uniqueVcenters = [];
        const seenUrls = new Set();
        for (const vcenter of allVcenters) {
            if (!seenUrls.has(vcenter.url) && !deletedUrls.has(vcenter.url)) {
                seenUrls.add(vcenter.url);
                uniqueVcenters.push(vcenter);
            }
        }

        // Populate the dropdown
        const vcenterDropdown = document.getElementById("vcenterDropdown");
        vcenterDropdown.innerHTML = "";
        uniqueVcenters.forEach(vcenter => {
            const option = document.createElement("div");
            option.className = "vcenter-option";
            option.innerHTML = `
                <span>${vcenter.name}</span>
                <i class="fas fa-check" style="display: none;"></i>
            `;
            option.onclick = () => selectVcenter(vcenter);
            vcenterDropdown.appendChild(option);
        });

        // Load the previously selected vCenter
        const selectedVcenterUrl = localStorage.getItem("selectedVcenter");
        const selectedVcenter = uniqueVcenters.find(vc => vc.url === selectedVcenterUrl) || uniqueVcenters[0];
        if (selectedVcenter) {
            document.getElementById("vcenterSelected").textContent = selectedVcenter.name;
            const options = vcenterDropdown.querySelectorAll(".vcenter-option");
            options.forEach(opt => {
                const checkIcon = opt.querySelector("i");
                checkIcon.style.display = opt.textContent === selectedVcenter.name ? "inline" : "none";
            });
        } else {
            document.getElementById("vcenterSelected").textContent = "Select vCenter";
        }
    }

    function selectVcenter(vcenter) {
        const vcenterSelected = document.getElementById("vcenterSelected");
        const vcenterDropdown = document.getElementById("vcenterDropdown");
        vcenterSelected.textContent = vcenter.name;
        localStorage.setItem("selectedVcenter", vcenter.url);
        
        // Update checkmark
        const options = vcenterDropdown.querySelectorAll(".vcenter-option");
        options.forEach(opt => {
            const checkIcon = opt.querySelector("i");
            checkIcon.style.display = opt.textContent === vcenter.name ? "inline" : "none";
        });

        vcenterDropdown.classList.remove("active");

        // Switch to the selected vCenter
        switchVcenter(vcenter.url);
    }

    function switchVcenter(vcenterUrl) {
        // Show a loading modal
        const progressModal = document.getElementById("progressModal");
        const categoryNameElement = document.getElementById("categoryName");
        const progressBar = document.getElementById("progressBar");
        categoryNameElement.textContent = "vCenter Data";
        progressModal.style.display = "flex";
        setTimeout(() => progressModal.classList.add("active"), 10);

        // Check authentication status
        const authTokens = JSON.parse(localStorage.getItem("authTokens")) || {};
        const isAuthenticated = !!authTokens[vcenterUrl];
        const currentVcenter = localStorage.getItem("selectedVcenter");

        // If selecting the same vCenter and already authenticated, do nothing
        if (vcenterUrl === currentVcenter && isAuthenticated) {
            progressModal.classList.remove("active");
            setTimeout(() => progressModal.style.display = "none", 300);
            return;
        }

        // Determine redirect URL based on authentication
        let redirectUrl;
        if (isAuthenticated) {
            // If authenticated, redirect to the VM list for the selected vCenter
            redirectUrl = "{% url 'login_page' %}?vcenter=" + encodeURIComponent(vcenterUrl);
        } else {
            // If not authenticated, redirect to the login page with the target vCenter
            redirectUrl = "{% url 'login_page' %}?vcenter=" + encodeURIComponent(vcenterUrl);
        }
        

        // Simulate a fetch with progress bar
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            progressBar.style.width = `${progress}%`;
            if (progress >= 100) {
                clearInterval(interval);
                // Redirect to the appropriate page
                window.location.href = redirectUrl;
            }
        }, 100);
    }

    // Toggle vCenter dropdown
    document.getElementById("vcenterSwitcher").addEventListener("click", () => {
        const vcenterDropdown = document.getElementById("vcenterDropdown");
        vcenterDropdown.classList.toggle("active");
        document.querySelector("#vcenterSwitcher i").style.transform = vcenterDropdown.classList.contains("active") ? "scale(1.2)" : "scale(1)";
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
        const vcenterSwitcher = document.getElementById("vcenterSwitcher");
        const vcenterDropdown = document.getElementById("vcenterDropdown");
        if (!vcenterSwitcher.contains(e.target)) {
            vcenterDropdown.classList.remove("active");
            document.querySelector("#vcenterSwitcher i").style.transform = "scale(1)";
        }
    });

    function toggleSidebar() {
        let sidebar = document.getElementById("sidebar");
        let content = document.getElementById("content");
        let toggleBtn = document.querySelector(".toggle-btn");
        sidebar.classList.toggle("active");
        content.classList.toggle("shifted");
        toggleBtn.classList.toggle("active"); 
    }

    document.querySelectorAll(".sidebar ul li a").forEach(item => {
        item.addEventListener("click", function (e) {
            if (e.target.classList.contains("dropdown-toggle-icon")) return;
            document.querySelectorAll(".sidebar ul li a").forEach(link => link.classList.remove("active"));
            this.classList.add("active");
            localStorage.setItem("selectedSidebarItem", this.getAttribute("href"));
        });
    });

    document.addEventListener("DOMContentLoaded", () => {
        let selectedItem = localStorage.getItem("selectedSidebarItem");
        if (selectedItem) {
            let activeLink = document.querySelector(`.sidebar ul li a[href="${selectedItem}"]`);
            if (activeLink) activeLink.classList.add("active");
        }
        // Load vCenters on page load
        loadVcenters();
    });

    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    document.getElementById("profile").addEventListener("click", () => {
        let dropdown = document.getElementById("profileDropdown");
        dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
        document.querySelector("#profile i").style.transform = dropdown.style.display === "block" ? "scale(1.2)" : "scale(1)";
    });

    document.getElementById("notification").addEventListener("click", () => {
        document.querySelector("#notification i").style.transform = "rotate(15deg)";
        setTimeout(() => document.querySelector("#notification i").style.transform = "rotate(0deg)", 300);
        alert("Notifications: 3 new events!");
    });

    // Initialize vmChart with persisted or default data
    let vmChart;
    document.addEventListener('DOMContentLoaded', function() {
        const vmCtx = document.getElementById('vmChart').getContext('2d');
        if (!vmCtx) {
            console.error("Canvas element 'vmChart' not found");
            return;
        }

        // Get persisted data from localStorage, or use default values
        const persistedData = localStorage.getItem('vmChartData');
        const hasPersistedData = persistedData !== null;
        const initialData = hasPersistedData ? JSON.parse(persistedData) : [0, 0, 0]; // Start with zeros if no data
        const totalVms = initialData.reduce((sum, value) => sum + value, 0);

        // Update the total VMs display with persisted data
        const totalVmsElement = document.getElementById('total-vms');
        if (totalVmsElement && hasPersistedData) {
            totalVmsElement.textContent = `Total VMs: ${totalVms}`;
        }

        // Setup chart container
        const chartBox = document.querySelector('.chart-box');
        const canvas = document.getElementById('vmChart');

        // Only show loading message if there's no persisted data
        let loadingDiv = null;
        if (!hasPersistedData) {
            canvas.style.display = 'none'; // Hide the canvas initially
            loadingDiv = document.createElement('div');
            loadingDiv.id = 'vmChartLoading';
            loadingDiv.style.textAlign = 'center';
            loadingDiv.style.padding = '20px';
            loadingDiv.style.color = '#2c3e50';
            loadingDiv.style.fontWeight = 'bold';
            loadingDiv.innerHTML = 'Loading VM Distribution...';
            chartBox.insertBefore(loadingDiv, canvas);
        } else {
            canvas.style.display = 'block'; // Show the canvas immediately if data exists
        }

        try {
            vmChart = new Chart(vmCtx, {
                type: 'pie',
                data: {
                    labels: ['Linux VMs', 'Windows VMs', 'Others'],
                    datasets: [{
                        data: initialData, // Use persisted or zeroed data
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                        borderWidth: 1
                    }]
                },
                options: {
    responsive: true,
    maintainAspectRatio: false,
    animation: { duration: 1000, easing: 'easeOutBounce' },
    hover: { mode: 'nearest', intersect: true, onHover: (event, chartElement) => {
        if (chartElement.length) {
            vmChart.canvas.style.animation = 'pulse 1s infinite';
        } else {
            vmChart.canvas.style.animation = 'none';
        }
    }},
    plugins: {
        legend: { position: 'top', labels: { color: 'black' } },
        tooltip: {
            enabled: true,
            backgroundColor: '#2c3e50',
            titleColor: '#fff',
            bodyColor: '#fff',
            callbacks: { label: function(tooltipItem) { return `${tooltipItem.label}: ${tooltipItem.raw}`; } },
            borderColor: '#FFFFFF',
            borderWidth: 1,
            padding: 10
        }
    },
    events: ['mousemove', 'mouseout', 'click']
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
                    hover: {
                        mode: 'nearest', // Enable hover mode to detect interactions
                        intersect: true
                    }
                }
            });
            console.log("Chart initialized successfully with initial data:", initialData);
        } catch (error) {
            console.error("Error initializing chart:", error);
        }

        // Add a custom click handler to the canvas for faster redirection with progress bar
        let isRedirecting = false; // Debounce flag to prevent multiple redirects
        canvas.addEventListener('click', async (event) => {
            if (isRedirecting) return; // Prevent multiple redirects

            const elements = vmChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);
            if (elements.length > 0) {
                isRedirecting = true; // Set the flag to prevent further clicks
                const chartElement = elements[0];
                const index = chartElement.index;
                const label = vmChart.data.labels[index]; // e.g., 'Linux VMs', 'Windows VMs', 'Others'
                const category = label.toLowerCase().replace(' vms', ''); // e.g., 'linux', 'windows', 'others'
                const redirectUrl = `/vm-category-list/${category}/`;

                console.log(`Initiating fetch for category: ${category}`);

                // Show the progress bar modal
                const progressModal = document.getElementById('progressModal');
                const categoryNameElement = document.getElementById('categoryName');
                const progressBar = document.getElementById('progressBar');
                categoryNameElement.textContent = category.charAt(0).toUpperCase() + category.slice(1); // Capitalize category
                progressModal.style.display = 'flex';
                setTimeout(() => progressModal.classList.add('active'), 42);

                // Track the start time of the fetch
                const startTime = Date.now();
                let progress = 0;
                let isFetchComplete = false;

                // Start the fetch operation and measure its duration
                const fetchStartTime = Date.now();
                const fetchPromise = fetch(redirectUrl, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request
                    }
                })
                .then(response => response.text()) // Parse the response as text (HTML)
                .then(() => {
                    const fetchEndTime = Date.now();
                    const fetchDuration = fetchEndTime - fetchStartTime; // Actual fetch duration
                    console.log(`Fetch completed in ${fetchDuration}ms`);
                    isFetchComplete = true; // Mark the fetch as complete
                })
                .catch(error => {
                    console.error(`Error fetching data for category ${category}:`, error);
                    const fetchEndTime = Date.now();
                    const fetchDuration = fetchEndTime - fetchStartTime; // Actual fetch duration even on error
                    console.log(`Fetch failed after ${fetchDuration}ms`);
                    isFetchComplete = true; // Mark as complete even on error to proceed with redirect
                });

                // Animate the progress bar to match the fetch duration
                const animationLoop = async () => {
                    // Fallback maximum duration in case fetch takes too long
                    const maxDuration = 30000; // 30 seconds
                    while (!isFetchComplete) {
                        const elapsedTime = Date.now() - startTime;
                        // Use a linear progression with an ease-in-out effect
                        const t = Math.min(elapsedTime / maxDuration, 1); // Normalize time to [0, 1]
                        // Apply ease-in-out transformation
                        const easedT = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                        progress = easedT * 99; // Scale to 99% until fetch completes
                        progressBar.style.width = `${progress}%`;
                        await new Promise(resolve => setTimeout(resolve, 10)); // Update every 10ms for smoothness
                    }

                    // Fetch is complete, set progress to 100% and redirect immediately
                    progressBar.style.width = '100%';
                    window.location.assign(redirectUrl); // Use assign for reliable navigation
                    isRedirecting = false; // Reset the flag after redirection
                };

                // Start the animation loop
                animationLoop();

                // Store the progress bar state and category in sessionStorage
                sessionStorage.setItem('showProgressBar', 'true');
                sessionStorage.setItem('loadingCategory', category);
            }
        });
    });

    // Update chart when new data is fetched via HTMX
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.target.id === 'vm-distribution-data') {
            const dataElement = evt.target;
            const linuxVms = parseInt(dataElement.getAttribute('data-linux-vms')) || 0;
            const windowsVms = parseInt(dataElement.getAttribute('data-windows-vms')) || 0;
            const others = parseInt(dataElement.getAttribute('data-others')) || 0;

            // Calculate total VMs
            const totalVms = linuxVms + windowsVms + others;

            // Update the total VMs display
            const totalVmsElement = document.getElementById('total-vms');
            if (totalVmsElement) {
                totalVmsElement.textContent = `Total VMs: ${totalVms}`;
            }

            // Update the chart with new data
            console.log(`Updating chart with Linux: ${linuxVms}, Windows: ${windowsVms}, Others: ${others}`);
            if (vmChart) {
                vmChart.data.datasets[0].data = [linuxVms, windowsVms, others];
                vmChart.update();
                console.log("Chart updated successfully");

                // Persist the new data to localStorage
                localStorage.setItem('vmChartData', JSON.stringify([linuxVms, windowsVms, others]));
                console.log("Chart data persisted to localStorage");

                // Show the canvas and hide the loading message if it exists
                const canvas = document.getElementById('vmChart');
                const loadingDiv = document.getElementById('vmChartLoading');
                if (canvas && loadingDiv) {
                    canvas.style.display = 'block'; // Show the canvas
                    loadingDiv.style.display = 'none'; // Hide the loading message
                }
            } else {
                console.error("vmChart is not initialized");
            }
        }
    });

    const ctx2 = document.getElementById('uptimeChart').getContext('2d');
    const uptimeChart = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Server Uptime (%)',
                data: [50, 99.8, 75, 40, 52, 88.2, 92.3],
                borderColor: '#9b59b6',
                fill: false
            }]
        },
        options: {
            responsive: true,
            animation: { duration: 1500, easing: 'easeInOutQuart' },
            plugins: { tooltip: { backgroundColor: '#2c3e50', titleColor: '#fff', bodyColor: '#fff' } }
        }
    });

    function showLogoutModal() {
        let modal = document.getElementById("logoutModal");
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
    }

    function closeLogoutModal() {
        let modal = document.getElementById("logoutModal");
        modal.classList.remove("active");
        setTimeout(() => modal.style.display = "none", 300);
    }

    function confirmLogout() {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = "{% url 'login_page' %}";
    }

    setInterval(() => {
        document.getElementById("vm-users").textContent = Math.floor(Math.random() * 10 + 145);
        document.getElementById("active-sessions").textContent = Math.floor(Math.random() * 5 + 40);
        document.getElementById("uptime").textContent = (99 + Math.random()).toFixed(2) + "%";
        document.getElementById("recent-logins").textContent = Math.floor(Math.random() * 3 + 4);
        let cpuLoad = Math.random() * 100;
        document.getElementById("cpu-status").textContent = cpuLoad < 70 ? "Normal" : cpuLoad < 90 ? "High" : "Critical";
        document.getElementById("cpu-status").parentElement.querySelector(".status-indicator").className = 
            `status-indicator ${cpuLoad < 70 ? "status-green" : cpuLoad < 90 ? "status-yellow" : "status-red"}`;
    }, 5000);

    document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");
    });

    document.querySelectorAll(".sidebar .dropdown-toggle-icon").forEach(toggle => {
        toggle.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const dropdown = toggle.closest("li").querySelector(".dropdown-menu");
            dropdown.classList.toggle("show");
            toggle.classList.toggle("rotate");
        });
    });

    document.querySelectorAll(".sidebar .dropdown-submenu").forEach(submenu => {
        const toggle = submenu.querySelector(".dropdown-toggle");
        const subMenu = submenu.querySelector(".sub-menu");
        toggle.addEventListener("click", (e) => {
            e.preventDefault();
            subMenu.classList.toggle("show");
        });
    });

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        console.log("HTMX swap completed for recent activity:", evt.detail);
    });

    htmx.logAll();

    // Override toggleSidebar to include localStorage persistence
    const originalToggleSidebar = toggleSidebar;
    toggleSidebar = function() {
        originalToggleSidebar();
        let sidebar = document.getElementById("sidebar");
        localStorage.setItem("sidebarState", sidebar.classList.contains("active") ? "active" : "inactive");
    };

    document.addEventListener("DOMContentLoaded", () => {
        let sidebar = document.getElementById("sidebar");
        let content = document.getElementById("content");
        let toggleBtn = document.querySelector(".toggle-btn");
        let sidebarState = localStorage.getItem("sidebarState");
        if (sidebarState === "active" && !sidebar.classList.contains("active")) {
            sidebar.classList.add("active");
            content.classList.add("shifted");
            toggleBtn.classList.add("active");
        } else if (sidebarState !== "active" && sidebar.classList.contains("active")) {
            sidebar.classList.remove("active");
            content.classList.remove("shifted");
            toggleBtn.classList.remove("active");
        }
    });
</script>
<script>
let vmChart;

document.addEventListener('DOMContentLoaded', function() {
    const vmCtx = document.getElementById('vmChart').getContext('2d');
    if (!vmCtx) {
        console.error("Canvas element 'vmChart' not found");
        return;
    }

    // Get persisted data from localStorage, or use default values
    const persistedData = localStorage.getItem('vmChartData');
    const hasPersistedData = persistedData !== null;
    const initialData = hasPersistedData ? JSON.parse(persistedData) : [0, 0, 0]; // Start with zeros if no data
    const totalVms = initialData.reduce((sum, value) => sum + value, 0);

    // Update the total VMs display with persisted data
    const totalVmsElement = document.getElementById('total-vms');
    if (totalVmsElement && hasPersistedData) {
        totalVmsElement.textContent = `Total VMs: ${totalVms}`;
    }

    // Setup chart container
    const chartBox = document.querySelector('.chart-box');
    const canvas = document.getElementById('vmChart');

    // Only show loading message if there's no persisted data
    let loadingDiv = null;
    if (!hasPersistedData) {
        canvas.style.display = 'none'; // Hide the canvas initially
        loadingDiv = document.createElement('div');
        loadingDiv.id = 'vmChartLoading';
        loadingDiv.style.textAlign = 'center';
        loadingDiv.style.padding = '20px';
        loadingDiv.style.color = '#2c3e50';
        loadingDiv.style.fontWeight = 'bold';
        loadingDiv.innerHTML = 'Loading VM Distribution...';
        chartBox.insertBefore(loadingDiv, canvas);
    } else {
        canvas.style.display = 'block'; // Show the canvas immediately if data exists
    }

    try {
        vmChart = new Chart(vmCtx, {
            type: 'pie',
            data: {
                labels: ['Linux VMs', 'Windows VMs', 'Others'],
                datasets: [{
                    data: initialData, // Use persisted or zeroed data
                    backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                plugins: {
                    legend: { position: 'top', labels: { color: 'black' } },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#2c3e50',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        callbacks: { label: function(tooltipItem) { return `${tooltipItem.label}: ${tooltipItem.raw}`; } }
                    }
                },
                events: ['mousemove', 'mouseout', 'click'],
                hover: { mode: 'nearest', intersect: true }
            }
        });
        console.log("Chart initialized successfully with initial data:", initialData);
    } catch (error) {
        console.error("Error initializing chart:", error);
    }

    // Add a custom click handler to the canvas with progress bar
    let isRedirecting = false;
    canvas.addEventListener('click', async (event) => {
        if (isRedirecting) return;

        const elements = vmChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);
        if (elements.length > 0) {
            isRedirecting = true;
            const chartElement = elements[0];
            const index = chartElement.index;
            const label = vmChart.data.labels[index];
            const category = label.toLowerCase().replace(' vms', '');
            const redirectUrl = `/vm-category-list/${category}/`;

            console.log(`Initiating action for category: ${category}`);

            // Show the progress bar modal immediately
            const progressModal = document.getElementById('progressModal');
            const categoryNameElement = document.getElementById('categoryName');
            const progressBar = document.getElementById('progressBar');
            if (!progressModal || !categoryNameElement || !progressBar) {
                console.error("Progress modal elements not found");
                isRedirecting = false;
                return;
            }

            categoryNameElement.textContent = category.charAt(0).toUpperCase() + category.slice(1);
            progressModal.style.display = 'flex';
            setTimeout(() => progressModal.classList.add('active'), 10); // Ensure CSS transition

            // Simulate fetch with progress bar
            let progress = 0;
            const startTime = Date.now();
            let isFetchComplete = false;

            const fetchPromise = fetch(redirectUrl, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(() => {
                const fetchEndTime = Date.now();
                const fetchDuration = fetchEndTime - startTime;
                console.log(`Fetch completed in ${fetchDuration}ms`);
                isFetchComplete = true;
            })
            .catch(error => {
                console.error(`Error fetching data for category ${category}:`, error);
                isFetchComplete = true; // Mark as complete on error to proceed
            });

            

   // Animate the progress bar to match the fetch duration
                const animationLoop = async () => {
                    // Fallback maximum duration in case fetch takes too long
                    const maxDuration = 30000; // 30 seconds
                    while (!isFetchComplete) {
                        const elapsedTime = Date.now() - startTime;
                        // Use a linear progression with an ease-in-out effect
                        const t = Math.min(elapsedTime / maxDuration, 1); // Normalize time to [0, 1]
                        // Apply ease-in-out transformation
                        const easedT = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                        progress = easedT * 99; // Scale to 99% until fetch completes
                        progressBar.style.width = `${progress}%`;
                        await new Promise(resolve => setTimeout(resolve, 10)); // Update every 10ms for smoothness
                    }

                    // Fetch is complete, set progress to 100% and redirect immediately
                    progressBar.style.width = '100%';
                    window.location.assign(redirectUrl); // Use assign for reliable navigation
                    isRedirecting = false; // Reset the flag after redirection
                };

            animationLoop();
            sessionStorage.setItem('showProgressBar', 'true');
            sessionStorage.setItem('loadingCategory', category);
        }
    });
});

// Update chart and cache data when new data is fetched via HTMX
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target.id === 'vm-distribution-data') {
        const dataElement = evt.target;
        const linuxVms = parseInt(dataElement.getAttribute('data-linux-vms')) || 0;
        const windowsVms = parseInt(dataElement.getAttribute('data-windows-vms')) || 0;
        const others = parseInt(dataElement.getAttribute('data-others')) || 0;

        const totalVms = linuxVms + windowsVms + others;

        const totalVmsElement = document.getElementById('total-vms');
        if (totalVmsElement) {
            totalVmsElement.textContent = `Total VMs: ${totalVms}`;
        }

        if (vmChart) {
            vmChart.data.datasets[0].data = [linuxVms, windowsVms, others];
            vmChart.update();
            console.log("Chart updated successfully");

            // Persist the new data to localStorage
            localStorage.setItem('vmChartData', JSON.stringify([linuxVms, windowsVms, others]));
            console.log("Chart data persisted to localStorage");

            const canvas = document.getElementById('vmChart');
            const loadingDiv = document.getElementById('vmChartLoading');
            if (canvas && loadingDiv) {
                canvas.style.display = 'block';
                loadingDiv.style.display = 'none';
            }
        } else {
            console.error("vmChart is not initialized");
        }
    }
});

const ctx2 = document.getElementById('uptimeChart').getContext('2d');
const uptimeChart = new Chart(ctx2, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Server Uptime (%)',
            data: [50, 99.8, 75, 40, 52, 88.2, 92.3],
            borderColor: '#9b59b6',
            fill: false
        }]
    },
    options: {
        responsive: true,
        animation: { duration: 1500, easing: 'easeInOutQuart' },
        plugins: { tooltip: { backgroundColor: '#2c3e50', titleColor: '#fff', bodyColor: '#fff' } }
    }
});

function showLogoutModal() {
    let modal = document.getElementById("logoutModal");
    modal.style.display = "flex";
    setTimeout(() => modal.classList.add("active"), 10);
}

function closeLogoutModal() {
    let modal = document.getElementById("logoutModal");
    modal.classList.remove("active");
    setTimeout(() => modal.style.display = "none", 300);
}

function confirmLogout() {
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = "{% url 'login_page' %}";
}

setInterval(() => {
    document.getElementById("vm-users").textContent = Math.floor(Math.random() * 10 + 145);
    document.getElementById("active-sessions").textContent = Math.floor(Math.random() * 5 + 40);
    document.getElementById("uptime").textContent = (99 + Math.random()).toFixed(2) + "%";
    document.getElementById("recent-logins").textContent = Math.floor(Math.random() * 3 + 4);
    let cpuLoad = Math.random() * 100;
    document.getElementById("cpu-status").textContent = cpuLoad < 70 ? "Normal" : cpuLoad < 90 ? "High" : "Critical";
    document.getElementById("cpu-status").parentElement.querySelector(".status-indicator").className = 
        `status-indicator ${cpuLoad < 70 ? "status-green" : cpuLoad < 90 ? "status-yellow" : "status-red"}`;
}, 5000);

document.addEventListener("DOMContentLoaded", () => {
    if (localStorage.getItem("darkMode") === "true") document.body.classList.add("dark-mode");
});

document.querySelectorAll(".sidebar .dropdown-toggle-icon").forEach(toggle => {
    toggle.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        const dropdown = toggle.closest("li").querySelector(".dropdown-menu");
        dropdown.classList.toggle("show");
        toggle.classList.toggle("rotate");
    });
});

document.querySelectorAll(".sidebar .dropdown-submenu").forEach(submenu => {
    const toggle = submenu.querySelector(".dropdown-toggle");
    const subMenu = submenu.querySelector(".sub-menu");
    toggle.addEventListener("click", (e) => {
        e.preventDefault();
        subMenu.classList.toggle("show");
    });
});

document.body.addEventListener('htmx:afterSwap', function(evt) {
    console.log("HTMX swap completed for recent activity:", evt.detail);
});

htmx.logAll();

// Override toggleSidebar to include localStorage persistence
const originalToggleSidebar = toggleSidebar;
toggleSidebar = function() {
    originalToggleSidebar();
    let sidebar = document.getElementById("sidebar");
    localStorage.setItem("sidebarState", sidebar.classList.contains("active") ? "active" : "inactive");
};

document.addEventListener("DOMContentLoaded", () => {
    let sidebar = document.getElementById("sidebar");
    let content = document.getElementById("content");
    let toggleBtn = document.querySelector(".toggle-btn");
    let sidebarState = localStorage.getItem("sidebarState");
    if (sidebarState === "active" && !sidebar.classList.contains("active")) {
        sidebar.classList.add("active");
        content.classList.add("shifted");
        toggleBtn.classList.add("active");
    } else if (sidebarState !== "active" && sidebar.classList.contains("active")) {
        sidebar.classList.remove("active");
        content.classList.remove("shifted");
        toggleBtn.classList.remove("active");
    }
});

// Default vCenters (same as login.html)
const defaultVcenters = [
    { url: "https://coevcenter.lenovo.com", name: "Lenovo vCenter", source: "default" },
    { url: "https://backupvcenter.lenovo.com", name: "Backup Lenovo vCenter", source: "default" },
    { url: "https://testvc.coelab.com", name: "Test vCenter", source: "default" }
];

// Simulate authentication state (for demo purposes)
document.addEventListener("DOMContentLoaded", () => {
    let authTokens = JSON.parse(localStorage.getItem("authTokens")) || {};
    // Mock: Assume user is authenticated for the default vCenter only
    if (!authTokens["https://coevcenter.lenovo.com"]) {
        authTokens["https://coevcenter.lenovo.com"] = "mock-token-123";
    }
    localStorage.setItem("authTokens", JSON.stringify(authTokens));
});

function loadVcenters() {
    const storedVcenters = JSON.parse(localStorage.getItem("vcenters")) || [];
    const customVcenters = storedVcenters.map(vcenter => ({ ...vcenter, source: "custom" }));
    const deletedVcenters = JSON.parse(localStorage.getItem("deletedVcenters")) || [];
    const deletedUrls = new Set(deletedVcenters);
    
    // Combine all vCenters
    const allVcenters = [...defaultVcenters, ...customVcenters];
    
    // Remove duplicates and filter out deleted vCenters
    const uniqueVcenters = [];
    const seenUrls = new Set();
    for (const vcenter of allVcenters) {
        if (!seenUrls.has(vcenter.url) && !deletedUrls.has(vcenter.url)) {
            seenUrls.add(vcenter.url);
            uniqueVcenters.push(vcenter);
        }
    }

    // Populate the dropdown
    const vcenterDropdown = document.getElementById("vcenterDropdown");
    vcenterDropdown.innerHTML = "";
    uniqueVcenters.forEach(vcenter => {
        const option = document.createElement("div");
        option.className = "vcenter-option";
        option.innerHTML = `
            <span>${vcenter.name}</span>
            <i class="fas fa-check" style="display: none;"></i>
        `;
        option.onclick = () => selectVcenter(vcenter);
        vcenterDropdown.appendChild(option);
    });

    // Load the previously selected vCenter
    const selectedVcenterUrl = localStorage.getItem("selectedVcenter");
    const selectedVcenter = uniqueVcenters.find(vc => vc.url === selectedVcenterUrl) || uniqueVcenters[0];
    if (selectedVcenter) {
        document.getElementById("vcenterSelected").textContent = selectedVcenter.name;
        const options = vcenterDropdown.querySelectorAll(".vcenter-option");
        options.forEach(opt => {
            const checkIcon = opt.querySelector("i");
            checkIcon.style.display = opt.textContent === selectedVcenter.name ? "inline" : "none";
        });
    } else {
        document.getElementById("vcenterSelected").textContent = "Select vCenter";
    }
}

function selectVcenter(vcenter) {
    const vcenterSelected = document.getElementById("vcenterSelected");
    const vcenterDropdown = document.getElementById("vcenterDropdown");
    vcenterSelected.textContent = vcenter.name;
    localStorage.setItem("selectedVcenter", vcenter.url);
    
    // Update checkmark
    const options = vcenterDropdown.querySelectorAll(".vcenter-option");
    options.forEach(opt => {
        const checkIcon = opt.querySelector("i");
        checkIcon.style.display = opt.textContent === vcenter.name ? "inline" : "none";
    });

    vcenterDropdown.classList.remove("active");

    // Switch to the selected vCenter
    switchVcenter(vcenter.url);
}

function switchVcenter(vcenterUrl) {
    // Show a loading modal
    const progressModal = document.getElementById("progressModal");
    const categoryNameElement = document.getElementById("categoryName");
    const progressBar = document.getElementById("progressBar");
    categoryNameElement.textContent = "vCenter Data";
    progressModal.style.display = "flex";
    setTimeout(() => progressModal.classList.add("active"), 10);

    // Check authentication status
    const authTokens = JSON.parse(localStorage.getItem("authTokens")) || {};
    const isAuthenticated = !!authTokens[vcenterUrl];
    const currentVcenter = localStorage.getItem("selectedVcenter");

    // If selecting the same vCenter and already authenticated, do nothing
    if (vcenterUrl === currentVcenter && isAuthenticated) {
        progressModal.classList.remove("active");
        setTimeout(() => progressModal.style.display = "none", 300);
        return;
    }

    // Determine redirect URL based on authentication
    let redirectUrl;
    if (isAuthenticated) {
        // If authenticated, redirect to the VM list for the selected vCenter
        redirectUrl = "{% url 'login_page' %}?vcenter=" + encodeURIComponent(vcenterUrl);
    } else {
        // If not authenticated, redirect to the login page with the target vCenter
        redirectUrl = "{% url 'login_page' %}?vcenter=" + encodeURIComponent(vcenterUrl);
    }
    

    // Simulate a fetch with progress bar
    let progress = 0;
    const interval = setInterval(() => {
        progress += 5;
        progressBar.style.width = `${progress}%`;
        if (progress >= 100) {
            clearInterval(interval);
            // Redirect to the appropriate page
            window.location.href = redirectUrl;
        }
    }, 100);
}

// Toggle vCenter dropdown
document.getElementById("vcenterSwitcher").addEventListener("click", () => {
    const vcenterDropdown = document.getElementById("vcenterDropdown");
    vcenterDropdown.classList.toggle("active");
    document.querySelector("#vcenterSwitcher i").style.transform = vcenterDropdown.classList.contains("active") ? "scale(1.2)" : "scale(1)";
});

// Close dropdown when clicking outside
document.addEventListener("click", (e) => {
    const vcenterSwitcher = document.getElementById("vcenterSwitcher");
    const vcenterDropdown = document.getElementById("vcenterDropdown");
    if (!vcenterSwitcher.contains(e.target)) {
        vcenterDropdown.classList.remove("active");
        document.querySelector("#vcenterSwitcher i").style.transform = "scale(1)";
    }
});

function toggleSidebar() {
    let sidebar = document.getElementById("sidebar");
    let content = document.getElementById("content");
    let toggleBtn = document.querySelector(".toggle-btn");
    sidebar.classList.toggle("active");
    content.classList.toggle("shifted");
    toggleBtn.classList.toggle("active"); 
}

document.querySelectorAll(".sidebar ul li a").forEach(item => {
    item.addEventListener("click", function (e) {
        if (e.target.classList.contains("dropdown-toggle-icon")) return;
        document.querySelectorAll(".sidebar ul li a").forEach(link => link.classList.remove("active"));
        this.classList.add("active");
        localStorage.setItem("selectedSidebarItem", this.getAttribute("href"));
    });
});

document.addEventListener("DOMContentLoaded", () => {
    let selectedItem = localStorage.getItem("selectedSidebarItem");
    if (selectedItem) {
        let activeLink = document.querySelector(`.sidebar ul li a[href="${selectedItem}"]`);
        if (activeLink) activeLink.classList.add("active");
    }
    // Load vCenters on page load
    loadVcenters();
});

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
}

document.getElementById("profile").addEventListener("click", () => {
    let dropdown = document.getElementById("profileDropdown");
    dropdown.style.display = dropdown.style.display === "block" ? "none" : "block";
    document.querySelector("#profile i").style.transform = dropdown.style.display === "block" ? "scale(1.2)" : "scale(1)";
});

document.getElementById("notification").addEventListener("click", () => {
    document.querySelector("#notification i").style.transform = "rotate(15deg)";
    setTimeout(() => document.querySelector("#notification i").style.transform = "rotate(0deg)", 300);
    alert("Notifications: 3 new events!");
});


document.addEventListener('scroll', () => {
    const header = document.querySelector('.dashboard-header');
    const scrollPosition = window.scrollY;
    header.style.transform = `translateY(${scrollPosition * 0.3}px)`;
});


 </script>   
</body>
</html>





















